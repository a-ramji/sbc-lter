---
title: "SBC LTER analysis"
author: "Anna Ramji"
format: html
editor: visual
---

```{r}

```

## Introduction

In this Quarto Document, I'll be working with data from the Santa Barbara Coast LTER sites, analyzing data using statistical analysis methods covered in the Master of Environmental Data Science program's Environmental Data Science (EDS) 222: Statistics for Environmental Data Science course taught by Tamma Carleton (tcarleton\@ucsb.edu).

## Background

(Putting essential background information here)

(setting up the problem)

(metadata, column info, etc.)

### Dataset 1: Kelp Forest dynamics: Fish abundance

Reed, D. and R. Miller. 2023. SBC LTER: Reef: Kelp Forest Community Dynamics: Fish abundance ver 38. Environmental Data Initiative. https://doi.org/10.6073/pasta/92003d368dfe121f6709ad1507412f66 (Accessed 2023-11-22)

### Dataset 2: CA Spiny Lobster Data

Reed, D. and R. Miller. 2023. SBC LTER: Reef: Abundance, size and fishing effort for California Spiny Lobster (Panulirus interruptus), ongoing since 2012 ver 9. Environmental Data Initiative. https://doi.org/10.6073/pasta/3595322687af94cd532620ad9db94c77 (Accessed 2023-11-22).

### Dataset 3: Feeding relationships

Santa Barbara Coastal LTER, J.E. Byrnes, D.C. Reed, B.J. Cardinale, K.C. Cavanaugh, S.J. Holbrook, and R.J. Schmitt. 2022. SBC LTER: Reef: Feeding relationships for kelp forest species ver 4. Environmental Data Initiative. https://doi.org/10.6073/pasta/e82a082f4440d469c84e11a265266004 (Accessed 2023-11-22).

### Importing libraries

```{r libraries, warning=FALSE, message=FALSE}
library(tidyverse)
library(readr)
library(gt)
library(tufte)
library(feasts)
library(here)
library(patchwork)
library(janitor)
library(tsibble)
library(forecast)
library(lubridate)

library(vegan) # for diversity index

```

## Reading in the Data

```{r}



```

```{r lobsters_fp}
# using the package `here()`

# setting the file path for our lobster abundance csv
lobster_abundance_fp <- here("data", "lobsters", "knb-lter-sbc.77.9",  "Lobster_Abundance_All_Years_20230831.csv")

# and setting the file path for our lobster trap counts csv
lobster_trap_counts_fp <- here("data", "lobsters", "knb-lter-sbc.77.9", "Lobster_Trap_Counts_All_Years_20210519.csv")
```


```{r lobsters_readin}
lobster_abd <- read_csv(lobster_abundance_fp, na = c("-99999")) |> 
  clean_names() |> 
  select(-year, -month)
#|> 
 # mutate("year" = lubridate::as_date(year))

lobster_trap <- read_csv(lobster_trap_counts_fp, na = c("-99999")) |> 
  clean_names()

head(lobster_abd)
tail(lobster_abd)
# head(lobster_trap)
```



```{r}
# setting file path for fish abundance
fish_abd_fp <- here("data", "fish_abundance", "knb-lter-sbc.17.38", "Annual_fish_comb_20230814.csv")

fish_abd <- read_csv(fish_abd_fp, na = c("-99999")) |> 
  clean_names() |> 
  select(-year, -month) |> 
  filter(taxon_class %in% c("Actinopterygii"))

head(fish_abd)
tail(fish_abd)
```

```{r}
unique(fish_abd$taxon_order)
```


```{r}
unique(fish_abd$taxon_genus)
unique(fish_abd$taxon_class)

```


```{r}
# setting water temperature file path
water_temp_fp <- here("data", "water-temp", "knb-lter-sbc.13.29", "Bottom_temp_all_years_20230724.csv")

water_temp <- read_csv(water_temp_fp, na = c("-99999")) |> 
  clean_names() |> 
  rename("date" = date_local, "time" = time_local) |> 
  select(-serial) |> 
  group_by(date)

head(water_temp)
tail(water_temp)
```





```{r}
sum(is.na(water_temp$temp_c))

```


```{r lobster_temp_join}
lobster_abd_temp <- left_join(lobster_abd, water_temp, by = c("date", "site")) |> 
  drop_na(temp_c)

head(lobster_abd_temp)
```

```{r}
# sum(is.na(lobster_abd_temp$temp_c))

```


```{r lobster_joined_group}

lobster_summary <- lobster_abd_temp |> 
  group_by(date, site) |> 
  summarize(mean_temp = round(mean(temp_c, na.rm = TRUE), 3),
            count = n())
  
lobster_summary

```


```{r lobster_temp_reg}
lobster_regression <- lm(formula = temp_c ~ count, data = lobster_abd_temp)

summary(lobster_regression)

```

```{r}

lobster_abd_temp |> 
  ggplot(data = lobster_abd_temp) +
  geom_jitter(aes(x = temp_c, y = count,
                  color = site)) +
  facet_wrap(~site) 

    


```

```{r}
ggplot(data = lobster_summary) +
  geom_line(aes(x = date, y = mean_temp))

```


```{r}
acf(water_temp$temp_c, lag.max=12)
```



```{r}

#lobster_abd_temp |> forecast::autoplot()

# as_tsibble(lobster_abd_temp) %>%
#   model(
#     classical_decomposition(value, type = "additive")
#   ) %>%
#   components() %>%
#   autoplot() 
```



```{r fish_temp}

fish_temp <- left_join(fish_abd, water_temp, by = c("date", "site")) |> 
  drop_na(temp_c)

head(fish_temp)
```

```{r}
fish_temp_summary <- fish_temp  |> 
  group_by(date, scientific_name, site) |> 
  summarize(mean_temp = (mean(temp_c, na.rm = TRUE)),
            count = n())
fish_temp_summary

```


```{r iucn-data}

iucn_fp <- here("data", "redlist_species_data_all_fish", "assessments.csv")

iucn_fish <- read_csv(iucn_fp) |> 
  clean_names() |> 
  select(scientific_name, redlist_category, population_trend)

head(iucn_fish)

iucn_fish_names <- list(unique(iucn_fish$scientific_name))
iucn_fish_names
# cross-selecting species 

fish_temp_iucn <- inner_join(fish_temp, iucn_fish) |> 
  select(-group, -mobility, -vis, -quad, -side)
head(fish_temp_iucn)

# nrow()

```


```{r}
fish_temp_summary |> 
  ggplot(aes(x = date,
             y = count,
             color=scientific_name)) +
  geom_point() +
  theme(legend.position = "none")
```


```{r plotting_function}

jitter_plot <- function(.data) {
  ggplot(data = .data, 
         aes(x = mean_temp,
             y = count)) +
    geom_jitter(alpha = 0.5) +
    geom_smooth(method='lm', formula= y~x, color="lightcoral", se=F, size=1.5) +
    labs(x = "Mean temperature (C)",
       y = "Count",
       title = "SBC LTER Average temperature (Celsius) over time") +
    theme_bw() 
}


```


```{r temp_time_plot}

temp_time_plot <- jitter_plot(.data = fish_temp_summary)

temp_time_plot
```





```{r}
fish_count_plot <- fish_temp_summary |> 
  ggplot(aes(x = mean_temp,
             y = count)) +
  geom_jitter() +
  geom_smooth(method='lm', formula= y~x, color="lightcoral", se=F, size=1.5) +
  theme_bw() +
  labs(x = "Mean temperature (C)",
       y = "Count",
       title = "SBC LTER Average temperature (Celsius) over time")


fish_count_plot


```


```{r}
hist(fish_temp_summary$mean_temp)
#hist(fish_temp_summary$count)

```

```{r fish_count_plot_facet}

fish_count_plot_facet <- fish_temp_summary |> 
  ggplot(aes(x = mean_temp,
             y = count)) +
  geom_jitter(alpha = 0.5) +
  geom_smooth(method='lm', formula= y~x, color="lightcoral", se=F, size=1.5) +
  facet_wrap(~site)
  theme_bw() +
  labs(x = "Mean temperature (C)",
       y = "Count",
       title = "SBC LTER Average temperature (Celsius) over time")


fish_count_plot_facet


```


```{r site_selections}

carp <- fish_temp_summary |> 
  filter(site %in% c("CARP"))

carp_plot <-  jitter_plot(.data = carp) +
  labs(subtitle = "Carpenteria Test Site (CARP)")
carp_plot


```




```{r}



# fish_temp_summary |> 
# ggplot(aes(x = mean_temp,
#              y = count)) +
#   geom_jitter(alpha = 0.5) +
#   geom_smooth(method='lm', formula= y~x, color="lightcoral", se=F, size=1.5) +
#   facet_wrap(~scientific_name)
#   theme_bw() +
#   labs(x = "Mean temperature (C)",
#        y = "Count",
#        title = "SBC LTER Average temperature (Celsius) over time")

```



```{r}



```




make diversity index, look at relationship between water temp and diversity


group by site, date

summarize with shannon index
https://rdrr.io/cran/vegan/man/diversity.html 



Null hypothesis: water temperature has zero correlation with fish diversity
Alternative hypothesis: water temperature is correlated with fish diversity



```{r diversity}
fish_diversity_df <- fish_temp_iucn |> 
  select(date, site, count, temp_c, scientific_name, common_name, time, redlist_category, population_trend) |> 
  mutate(year = lubridate::year(date)) |> 
  relocate(year, .before = site) |> 
  select(-date, -time) |> 
  group_by(year, site, temp_c)
#|> 
 # summarize(crit = sum(count))

fish_diversity <- fish_diversity_df |> 
  summarize(index = vegan::diversity(count, index = "shannon"))

head(fish_diversity)

summary(lm(formula = index~temp_c))
# take average for each year
```


1.. site year index
2. site year temp -- average per site per year
3. site year iucn status

```{r}
fish_diversity |> 
  ggplot(aes(x = temp_c))

```






```{r food-web}

food_web <- read_csv("data/food_web/knb-lter-sbc.56.4/byrnes_foodweb_table1.csv", na = c("-99999")) |> 
  clean_names() 


```

